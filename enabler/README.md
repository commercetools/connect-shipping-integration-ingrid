# Shipping Integration Enabler

This module provides an application based on [commercetools Connect](https://docs.commercetools.com/connect), which acts a wrapper implementation to cover frontend components provided by Ingrid delivery platform.

Ingrid provides widget in HTML format that can be used on client side to load on browser which securely render DOM elements for shipping address and shipping option inputs. The widget takes control the collection of delivery details in Ingrid platform. Now, with the usage of `enabler`, it allows the control to checkout product on when and how to load the `enabler` as connector UI based on business configuration.

## Usage

The `enabler` provides following three functions:

- mount() - It accepts DOM Element ID so that Ingrid widget can be embedded into it.
- init() - It asks the Ingrid platform to initialize delivery session and generate the Ingrid widget for frontend usage.
- update() - It synchronizes the latest shipping options into the cart which is stored in commercetools composable commerce platform.

Following shows how to instantiate web component by `enabler` in frontend

```typescript
// dynamically import the enabler javascript bundle
const initEnabler = async () => {
    const enabler = await import(import.meta.env.VITE_ENABLER_URL)
        .then(({ Enabler }) => {
            const enabler = new Enabler({
                processorUrl: import.meta.env.VITE_PROCESSOR_URL, // inject the processor URL in environment variable
                sessionId: session?.id, // inject the commercetools checkout session ID
                onInitCompleted: ({
                    isSuccess: true;
                    ingridSessionId: string; // passing delivery session ID generated by Ingrid platform
                    ingridHtml: string; // HTML snippet generated by Ingrid platform
                    cartVersion: number; // version of cart defined by commercetools composable commerce
                }) => {
                    // Callback function after init() in enabler is completed. the follow-up operations handled in front-end can be defined here.
                },
                onUpdateCompleted: ({
                    isSuccess: boolean,
                    ingridSessionId: string; // passing delivery session ID generated by Ingrid platform
                    cartVersion: number; // version of cart defined by commercetools composable commerce
                }) => {
                    // Callback function after update() in enabler is completed. The follow-up operations handled in front-end can be defined here.
                },
                onError: (err: Error) => {
                    // Callback function if error in enabler happened. The follow-up operations handled in front-end can be defined here.
                },
            });
            return enabler;
        })
        .catch((err) => {
            // Failed to load IngridShippingEnabler
        });

    enabler.createComponentBuilder();
    const builder = await enabler.createComponentBuilder();
    const enablerComponent = builder.build();
    return enablerComponent;
};
```

To mount the DOM element for Ingrid widget with `enabler`

```javascript
<div id=${elementIdForIngridWidget} />
enablerComponent.mount(elementIdForIngridWidget);
```

To trigger Ingrid delivery session initialization

```typescript
enablerComponent.init(voucherCodes); 
```

Currently the connector synchronizesthe latest delivery options from Ingrid to commercetools composable commerce at the moment user interacts with Ingrid widget. Enabler component triggers update function when Ingrid events are captured in client side. For details of Ingrid event capture, please refer to the [guide of Ingrid frontend integration](https://developer.ingrid.com/delivery_checkout/frontend_integration/index.html).

```typescript
async init(voucherCodes: string[]) {

    // Trigger Ingrid delivery session initialization
    ...

    // Capture Ingrid events from widget
    window._sw((api: Api) => {
        api.on("data_changed", (data, meta) => {
            if(!(meta as DataChangedMeta).initial_load) {
              console.log("data_changed: data", data);
              console.log("data_changed: meta", meta);
              this.update(voucherCodes);
            }
        });
        api.on("summary_changed", (data, meta) => {
            if((meta as SummaryChangedMeta).delivery_address_changed) {
              console.log("summary_changed: data", data);
              console.log("summary_changed: meta", meta);
              this.update(voucherCodes);
            }
        });

    });
}
```

Alternatively, it is supported to synchronize the latest delivery options from Ingrid to commercetools composable commerce from checkout page actions

```typescript
enablerComponent.update(); 

## Getting Started

Please run following npm commands under `enabler` folder for development work in local environment.

#### Install dependencies

```
$ npm install
```

#### Build the application in local environment. Javascript source codes are then generated under public folder

```
$ npm run build
```

#### Start server to host javascript SDK in port 8080

```
$ npm run start
```

#### Build development site in local environment. The location of the site is http://127.0.0.1:3000/

```
$ npm run dev
```

## Development Site

We also provide development site in `enabler` which can be used to load the `enabler` javascript SDK to simulate the checkout flow. The code can be found in `src/configurator`. To run development site, please make sure following environment variables has to be defined:

- `VITE_CTP_CLIENT_ID`: The client ID of your commercetools composable commerce user account. It is used in commercetools client to communicate with commercetools composable commerce.

- `VITE_CTP_CLIENT_SECRET`: The client secret of commercetools composable commerce user account. It is used in commercetools client to communicate with commercetools composable commerce.
- `VITE_CTP_PROJECT_KEY`: The key of commercetools composable commerce project.
- `VITE_CTP_AUTH_URL`: The URL for authentication in commercetools platform. It is used to generate OAuth 2.0 token which is required in every API call to commercetools composable commerce. The URL pattern is `https://auth.{region}.commercetools.com`. For details, please refer to documentation [here](https://docs.commercetools.com/tutorials/api-tutorial#authentication).
- `VITE_CTP_API_URL`: The URL for commercetools composable commerce API. The URL pattern is `https://api.{region}.commercetools.com`.
- `VITE_CTP_SESSION_URL`: The URL for session creation in commercetools platform. Connectors relies on the session created to be able to share information between enabler and processor. The URL pattern is `https://session.{region}.commercetools.com`.
- `VITE_PROCESSOR_URL`: The URL of the `processor`. This URL is required when instantiate enabler in development checkout site. If processor has been started locally by docker-compose. It would be http://localhost:8080.

- `VITE_ENABLER_URL`: The URL of the `enabler` javascript SDK. This URL is required to load the javascript SDK on the fly of loading the development checkout site. If `enabler` has been started locally by docker-compose, the URL should contain javascript SDK http://localhost:8888/connector-enabler.es.js.
- `VITE_CTP_APPLICATION_KEY`: The key of a commercetools checkout application to run payment-only flow. In order to execute payment in development site with the help of commercetools checkout SDK, a commercetools checkout application has to be created. The application key can be found in merchant center checkout section. To know more details, please refer to the [commercetools checkout documentation](https://docs.commercetools.com/checkout/installing-checkout).

To test `enabler` and `processor` in local environment, it is recommended to build them and the development site with docker-compose command. It has already arranged the forwarding port numbers without duplication.

To test `enabler` and `processor` in staging environment, you can start the development site with `npm run dev` command with remote `enabler` and `processor` URL configured in environment variables as listed above.
